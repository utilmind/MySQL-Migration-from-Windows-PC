Windows batch (.bat) scripts to make a dump for single or multiple databases into multiple separate .SQL-files OR ALL databases + ALL users and their grants into one single big SQL dump.

The goal is to make a dump that can be easily imported into MySQL/MariaDB, with all stored producedures, functions, triggers, views and of course users (definers) with their grants/privileges.

You make dump on Windows PC, which can be imported into any other MySQL or MariaDB server. Not necessarily hosted on Windows.

This also great for quick dump and deployment an empty database structure with all initial triggers and their definers.

# Key features
  ✔ Transfers all users and their grants/privileges (excluding system users, like *root*, *mariadb.sys* etc).<br />
  ✔ Doesn't touch system data tables like *mysql*, *sys*, *information_schema*, *performance_schema*.<br />
  ✔ Can dump data from separate databases into separate files or  produce all-in-one-dump.sql (with `--one` option).<br />
  ✔ Can strip MySQL compatibility comments, which break developers comments `/* ... */` inside of the db triggers. (So all dev's comments in code preserved for import into another db server.)<br />
  ✔ Supplements the dump with `CREATE TABLE` instructions that guarantee replication of the tables in their exactly original form, with original charset collations, ensuring that during import all data will be in the unchanged encoding, in the original row format and all other original table options. Particularly this solves problems with importing rows into fields with unique values, which, with a certain collation of the target server are considered as duplicates.

# Usage
Before using it __please open `db-migration.bat` with text/code editor__ and set up the path to MySQL/MariaDB executables (and maybe some other options, see the CONFIG part inside).

* `db-migration.bat`                   -> dump all databases separately (+ mysql.sql)
* `db-migration.bat --ONE`             -> dump all databases into ONE filem _databases.sql (just add `one`, case insensitive)<br />
&nbsp;&nbsp; &nbsp;&nbsp; <i>* EXCEPT system tables: `mysql`, `information_schema`, `performance_schema`, `sys`.</i>
* `db-migration.bat db1 db2 db3`       -> dump only listed databases separately.
* `db-migration.bat --ONE db1 db2 db3` -> dump only listed databases into single SQL, _databases.sql.

# MySQL Compatibility comments
MySQL and MariaDB dumps generated by mysqldump often contain “versioned” compatibility comments of the form:

<pre lang="markdown">
/*!50003 CREATE*/ /*!50017 DEFINER=`user`@`host`*/ /*!50003 TRIGGER ... END */;
</pre>

These `/*!xxxxx ... */` blocks are parsed and executed only on servers whose version is equal or higher than the encoded number (for example `50003` → 5.0.3). On older servers they are treated as regular comments and ignored. This mechanism was introduced to keep one dump file compatible with multiple MySQL versions.

On modern MySQL / MariaDB installations this legacy compatibility layer is usually no longer needed. In some cases it can even cause problems: when a versioned comment wraps an entire trigger or function body, any regular `/* ... */` comment inside can accidentally interact with the outer `/*!xxxxx ... */` block and break the SQL syntax when importing into newer servers.

The `strip-mysql-compatibility-comments.py` removes (unwraps) old versioned compatibility comments while preserving all normal comments and trigger/function bodies. The resulting dump is easier to read, imports cleanly on newer MySQL / MariaDB versions, and keeps developer comments inside routines intact (which is the most important, so you don’t need to remove comments in order to successfully import your triggers).

# More compatibility notes
* Some commands used in dump are incompatible with very old versions of MySQL. For example, `CREATE USER IF NOT EXISTS` appeared in MySQL syntax starting from v5.7.
So if you need to migrate very old data, replace it to just `CREATE USER` and remove `IF NOT EXISTS`.
* If you find more incompatibilities, please open discussion in the [Issues](../../issues) or pull your fix to this repo, feel free to edit this `README` as well.

# What you should remember upon migration of MySQL databases in general (with these tools or not)
  1. Никогда не трогать данные системных таблиц *(information_schema, performance_schema, mysql, sys)* и системных юзеров *(root, mariadb.sys etc)*. Если что-то было нарушено в системных данных — лучше переустановить всю базу с нуля.
  2. Не копируй базу данных банарными файлами. С MyISAM таблицами это может прокатить, а с InnoDB и другими — нет.
  3. (Очень важно и зачастую неочевидно!) Помни, что дефолтные таблицы символов и их коллации могут отличаться от сервера к серверу. Особенно часто они отличаются при апгрейдах сервера баз данных или переключении с одной версии MySQL/MariaDB на другую. Стандартный `mysqldump` пропускает опции для создания таблиц, если они совпадают с дефолтными опциями всего сервера. Поэтому при переносе данных очень важно, чтобы инструкции `CREATE TABLE` были полными, чтобы данные таблиц восстанавливались в оригинальной символьной таблице с оригинальной коллацией, а не дефолтной для сервера. Пример проблемы: вы импортируете таблицу с уникальным значением какого-то поля. В коллации `utf8mb4_general_ci` символы г и ґ считаются разными, в то время как коллация `utf8mb4_uca1400_ai_ci` не делает между ними разницы для поиска. Поэтому при попытке вставки в уникальное поле украинское слово «грати» (укр. играть) вы не сможете вставить слово «ґрати» (ворота). Или ещё пример, в некоторых коллациях слово naïve считается равнозначным naive, а вне которых — нет.
      Этот скрипт решает проблему ралличных коллаций при миграции, дополняя `CREATE TABLE` statements дампа необходимыми инструкциями для полного восстановления таблиц в оригинальной форме.
  5. (Просто совет) Ошибки при импорте баз данных могут остаться незамеченными, быстро промелькнув на экране терминала. Обязательно ловите ошибки импорта выводя их *error.log*. например, так:
      `mysql -u root -p < _db-dump.sql > errors.log`

# ToDo
* When we dump selected databases, let's dump users/grants only for *selected* databases.
* Maybe when I get inspired (or someone pays me :), I’ll make a tool that converts the MySQL syntax into SQLs compatible with Postgres, Oracle, etc. A simple tool for migrations between MySQL/MariaDB and PostgresSQL. I’m actually sure that something for migration between MySQL to PostgresSQL are already available, but still interested to build my own tool one day.
* Maybe I’ll convert these .bat’s to bash scripts for migration from Linux servers, but I’ll put them into different repository. This one is exclusively for Windows. Although [strip-mysql-compatibility-comments.py](strip-mysql-compatibility-comments.py) is universal and cross-platform, can be used everywhere.
